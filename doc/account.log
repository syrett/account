-- 专门作为数据库修改记录，具体数据库结构请看manage项目
-- stock 添加销售字段 订单号 order_no_sale
-- 添加了数据库表 product 销售 purchase 采购 stock 货品 bank 银行 cash 现金，

CREATE TABLE IF NOT EXISTS `bank` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `target` varchar(512) DEFAULT NULL COMMENT '交易对象',
  `date` varchar(64) DEFAULT NULL COMMENT '日期',
  `memo` text COMMENT '说明',
  `amount` float NOT NULL COMMENT '金额',
  `parent` int(11) DEFAULT NULL COMMENT '父，相关',
  `order` text COMMENT '订单号',
  `subject` varchar(16) DEFAULT NULL COMMENT '科目',
  `subject_2` int(12) DEFAULT NULL,
  `invoice` tinyint(4) DEFAULT '0' COMMENT '有无发票',
  `tax` int(8) DEFAULT NULL COMMENT '税率',
  `status_id` tinyint(4) NOT NULL DEFAULT '0' COMMENT '1:已经生成凭证 ',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `status_id` (`status_id`),
  KEY `created_at` (`created_at`),
  KEY `updated_at` (`updated_at`),
  KEY `parent` (`parent`),
  KEY `sbj_bank` (`subject_2`),
  KEY `sbj_bank_2` (`subject_2`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=378 ;

-- --------------------------------------------------------

--
-- 表的结构 `cash`
--

CREATE TABLE IF NOT EXISTS `cash` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `target` varchar(512) DEFAULT NULL COMMENT '交易对象',
  `date` varchar(64) DEFAULT NULL COMMENT '日期',
  `memo` text COMMENT '说明',
  `amount` float NOT NULL COMMENT '金额',
  `parent` int(11) DEFAULT NULL COMMENT '父，相关',
  `order` text COMMENT '订单号',
  `subject` varchar(16) DEFAULT NULL COMMENT '科目',
  `subject_2` int(12) DEFAULT NULL,
  `invoice` tinyint(4) DEFAULT '0' COMMENT '有无发票',
  `tax` int(8) DEFAULT NULL COMMENT '税率',
  `status_id` tinyint(4) NOT NULL DEFAULT '0' COMMENT '1:已经生成凭证 ',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `status_id` (`status_id`),
  KEY `created_at` (`created_at`),
  KEY `updated_at` (`updated_at`),
  KEY `parent` (`parent`),
  KEY `sbj_bank` (`subject_2`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;

CREATE TABLE IF NOT EXISTS `product` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `order_no` int(11) NOT NULL COMMENT '订单号',
  `saled_date` int(11) NOT NULL COMMENT '销售日期',
  `client_id` int(11) NOT NULL COMMENT '客户ID',
  `product` varchar(512) NOT NULL COMMENT '商品名称',
  `price` float NOT NULL COMMENT '价格',
  `amount` int(11) NOT NULL,
  `unit` varchar(32) NOT NULL COMMENT '单位',
  `tax` int(11) NOT NULL COMMENT '税率',
  `paied` float NOT NULL COMMENT '已收金额',
  `subject` int(11) DEFAULT NULL,
  `subject_2` int(11) DEFAULT NULL,
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` int(11) NOT NULL,
  `status_id` tinyint(4) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `client_id` (`client_id`),
  KEY `subject_2` (`subject_2`),
  KEY `subject` (`subject`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;

-- --------------------------------------------------------

--
-- 表的结构 `purchase`
--

CREATE TABLE IF NOT EXISTS `purchase` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(16) NOT NULL COMMENT '订单号',
  `entry_date` varchar(16) NOT NULL COMMENT '采购日期',
  `vendor_id` int(11) NOT NULL COMMENT '供应商ID',
  `entry_name` varchar(512) NOT NULL COMMENT '商品名称',
  `entry_memo` varchar(1024) DEFAULT NULL,
  `price` float NOT NULL COMMENT '价格',
  `count` int(11) NOT NULL DEFAULT '1',
  `unit` varchar(32) DEFAULT NULL COMMENT '单位',
  `tax` int(11) NOT NULL COMMENT '税率',
  `paied` float NOT NULL COMMENT '已付金额',
  `subject` int(11) DEFAULT NULL,
  `subject_2` int(11) DEFAULT NULL,
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` int(11) NOT NULL,
  `status_id` tinyint(4) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `vendor_id` (`vendor_id`),
  KEY `subject` (`subject`,`subject_2`),
  KEY `subject_2` (`subject_2`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=6 ;

-- --------------------------------------------------------

--
-- 表的结构 `stock`
--

CREATE TABLE IF NOT EXISTS `stock` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `no` varchar(64) NOT NULL COMMENT '编号',
  `order_no` varchar(16) NOT NULL COMMENT '采购订单',
  `order_no_sale` varchar(16) NOT NULL COMMENT '销售订单',
  `name` varchar(512) NOT NULL COMMENT '名字',
  `vendor_id` int(11) DEFAULT NULL COMMENT '供应商',
  `client_id` int(11) DEFAULT NULL COMMENT '销售动向，客户ID',
  `in_date` varchar(16) NOT NULL COMMENT '日期',
  `in_price` float NOT NULL COMMENT '价格',
  `out_date` timestamp NULL DEFAULT NULL,
  `out_price` float DEFAULT NULL,
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '1:正常，2出库，3退货',
  PRIMARY KEY (`id`),
  KEY `vendor_id` (`vendor_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=26 ;

-- transition 添加字段
alter table `transition`
  ADD COLUMN `data_type` varchar(16) default NULL COMMENT '类型' after `entry_date`,
  ADD COLUMN `data_id` int(11) NOT NULL COMMENT '原始数据ID' after `entry_date`,
  ADD COLUMN `entry_name` varchar(512) NOT NULL COMMENT '交易方名称' after `entry_date`;

-- employee 添加职位字段
alter table `employee`
    ADD COLUMN `position` varchar(32) default NULL Comment '职位' after department_id;

-- 添加视图
DROP TABLE IF EXISTS `condomdate`;

CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `condomdate` AS select max(`transition`.`entry_num_prefix`) AS `date` from `transition` where (`transition`.`entry_closing` = 1);

-- 添加表关系

ALTER TABLE `product`
  ADD CONSTRAINT `product_ibfk_1` FOREIGN KEY (`client_id`) REFERENCES `client` (`id`),
  ADD CONSTRAINT `product_ibfk_2` FOREIGN KEY (`subject`) REFERENCES `subjects` (`sbj_number`),
  ADD CONSTRAINT `product_ibfk_3` FOREIGN KEY (`subject_2`) REFERENCES `subjects` (`sbj_number`);

--
-- 限制表 `purchase`
--
ALTER TABLE `purchase`
  ADD CONSTRAINT `purchase_ibfk_1` FOREIGN KEY (`vendor_id`) REFERENCES `vendor` (`id`),
  ADD CONSTRAINT `purchase_ibfk_2` FOREIGN KEY (`subject`) REFERENCES `subjects` (`sbj_number`),
  ADD CONSTRAINT `purchase_ibfk_3` FOREIGN KEY (`subject_2`) REFERENCES `subjects` (`sbj_number`);

--
-- 限制表 `stock`
--
ALTER TABLE `stock`
  ADD CONSTRAINT `stock_ibfk_1` FOREIGN KEY (`vendor_id`) REFERENCES `vendor` (`id`) ON DELETE SET NULL,
  ADD CONSTRAINT `stock_ibfk_2` FOREIGN KEY (`client_id`) REFERENCES `client` (`id`) ON DELETE SET NULL;
--
-- 限制表 `bank`
--
ALTER TABLE `bank`
  ADD CONSTRAINT `bank_ibfk_1` FOREIGN KEY (`subject_2`) REFERENCES `subjects` (`sbj_number`);

--
-- 限制表 `cash`
--
ALTER TABLE `cash`
  ADD CONSTRAINT `cash_ibfk_1` FOREIGN KEY (`subject_2`) REFERENCES `subjects` (`sbj_number`);

-- 2015年7月22日19:44:15
-- stock 添加entry_subject cost_role成本计算方法
ALTER TABLE `stock` ADD `entry_subject` INT NULL AFTER `name`;
ALTER TABLE `stock` ADD `cost_role` INT NULL COMMENT '成本计算方法' AFTER `create_time`;
ALTER TABLE `stock` ADD FOREIGN KEY (`entry_subject`) REFERENCES `subjects`(`sbj_number`) ON DELETE RESTRICT ON UPDATE RESTRICT;

-- 新建表cost，成本结转


CREATE TABLE IF NOT EXISTS `cost` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(16) NOT NULL COMMENT '订单号',
  `entry_date` varchar(16) NOT NULL COMMENT '销售日期',
  `entry_name` varchar(512) NOT NULL COMMENT '商品名称',
  `stocks` varchar(512) NOT NULL COMMENT '商品清单',
  `stocks_count` varchar(512) NOT NULL COMMENT '对应数量',
  `stocks_price` varchar(512) NOT NULL COMMENT '对应当时计算价格',
  `entry_amount` float NOT NULL COMMENT '成本',
  `subject` int(11) DEFAULT NULL,
  `subject_2` varchar(11) DEFAULT NULL,
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` int(11) NOT NULL,
  `status_id` tinyint(4) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `subject_2` (`subject_2`),
  KEY `subject` (`subject`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;

--
-- 限制表 `cost`
--
ALTER TABLE `cost`
  ADD CONSTRAINT `cost_ibfk_2` FOREIGN KEY (`subject`) REFERENCES `subjects` (`sbj_number`) ON DELETE NO ACTION;
-- bank cash 添加 订单号字段
ALTER TABLE `bank` ADD `order_no` VARCHAR(16) NULL after id;
ALTER TABLE `cash` ADD `order_no` VARCHAR(16) NULL after id;



-- 2015年7月28日13:55:16
ALTER TABLE `purchase` ADD `department_id` INT NULL COMMENT '如果是公司自己使用，比如固定资产，需要填写部门' AFTER `entry_memo`;
ALTER TABLE `purchase` ADD INDEX(`department_id`);
ALTER TABLE `purchase` ADD FOREIGN KEY (`department_id`) REFERENCES `department`(`id`) ON DELETE RESTRICT ON UPDATE RESTRICT;
-- 修改stock表 字段，固定资产编码
ALTER TABLE `stock` CHANGE `no` `hs_no` VARCHAR(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '编号';

ALTER TABLE `cost` CHANGE `subject_2` `subject_2` VARCHAR(11) NULL DEFAULT NULL;
ALTER TABLE `options` CHANGE `entrynum` `value` FLOAT NOT NULL DEFAULT '0';
ALTER TABLE `options` CHANGE `id` `id` INT(11) NOT NULL AUTO_INCREMENT;
ALTER TABLE `options` ADD `entry_subject` INT(16) NOT NULL AFTER `id`;
DELETE FROM `options` WHERE 1;
ALTER TABLE `options` ADD INDEX(`entry_subject`);
ALTER TABLE `options` ADD FOREIGN KEY (`entry_subject`) REFERENCES `subjects`(`sbj_number`) ON DELETE RESTRICT ON UPDATE RESTRICT;
ALTER TABLE `options` CHANGE `url` `year` INT(16) NOT NULL DEFAULT 0 COMMENT '折旧或摊销年限';
ALTER TABLE `stock` ADD `worth` FLOAT NULL COMMENT '净值' AFTER `out_price`;
alter table options drop primary key;
ALTER TABLE `options` ADD PRIMARY KEY(`entry_subject`);
ALTER TABLE `stock` CHANGE `in_price` `in_price` DECIMAL(12,2) NOT NULL COMMENT '价格', CHANGE `out_price` `out_price` DECIMAL(12,2) NULL DEFAULT NULL, CHANGE `worth` `worth` DECIMAL(12,2) NULL DEFAULT NULL COMMENT '净值';


--2015年8月4日14:58:22
ALTER TABLE `employee` ADD `base` FLOAT NULL COMMENT '社保基数' AFTER `position`;
ALTER TABLE `stock` ADD `enable_date` DATE NULL COMMENT '固定资产等折旧起始日期,即物品开始使用的日期' AFTER `out_price`;
ALTER TABLE `salary`
ADD `social_personal` DECIMAL(12,2) NULL COMMENT '社保个人部分' AFTER `benefit_amount`,
ADD `provident_personal` DECIMAL(12,2) NULL COMMENT '公积金个人部分' AFTER `social_personal`,
ADD `personal_tax` DECIMAL(12,2) NULL COMMENT '个人所得税' AFTER `provident_personal`,
ADD `social_company` DECIMAL(12,2) NULL COMMENT '社保公司部分' AFTER `personal_tax`,
ADD `provident_company` DECIMAL(12,2) NULL COMMENT '公积金公司部分' AFTER `social_company`;
ALTER TABLE `salary` ADD `base_amount` DECIMAL(12,2) NULL COMMENT '当时社保基数' AFTER `benefit_amount`;
ALTER TABLE `salary` CHANGE `subject_2` `subject_2` VARCHAR(512) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL;
ALTER TABLE `reimburse` CHANGE `subject_2` `subject_2` VARCHAR(512) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL;
ALTER TABLE `cost` CHANGE `subject_2` `subject_2` VARCHAR(512) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL;
ALTER TABLE `purchase` DROP FOREIGN KEY `purchase_ibfk_3`;
ALTER TABLE `purchase` CHANGE `subject_2` `subject_2` VARCHAR(512) NULL DEFAULT NULL;
ALTER TABLE `product` DROP FOREIGN KEY `product_ibfk_3`;
ALTER TABLE `product` CHANGE `subject_2` `subject_2` VARCHAR(512) NULL DEFAULT NULL;